import * as THREE from 'three';

const chromaticityCanvas = document.getElementById('chromaticityCanvas');
if (!chromaticityCanvas) {
  throw new Error('chromaticityCanvas element not found');
}

const spaceCanvas = document.getElementById('spaceCanvas');
if (!spaceCanvas) {
  throw new Error('spaceCanvas element not found');
}

const pointSizeSlider = document.getElementById('pointSizeSlider');
const pointSizeValueLabel = document.getElementById('pointSizeValue');
const toggleMaxGamut = document.getElementById('toggleMaxGamut');
const toggleP3 = document.getElementById('toggleP3');
const toggleSRGB = document.getElementById('toggleSRGB');

const initialPointSizeValue = (() => {
  if (!pointSizeSlider) {
    return 1;
  }
  const parsed = parseFloat(pointSizeSlider.value);
  return Number.isFinite(parsed) ? parsed : 1;
})();

const viewers = [];
const clock = new THREE.Clock();
const CHROMATICITY_MAX = 0.9;
const chromaticityMatch = new THREE.Vector2(0.0, 0.0);
const chromaticityMatchHover = chromaticityMatch.clone();

function setupChromaticityPointerTracking(canvas) {
  if (!canvas) {
    return;
  }

  const updateHoverFromEvent = (event) => {
    if (event.cancelable) {
      event.preventDefault();
    }
    const rect = canvas.getBoundingClientRect();
    if (!rect.width || !rect.height) {
      return;
    }
    const localX = (event.clientX - rect.left) / rect.width;
    const localY = (event.clientY - rect.top) / rect.height;
    const clampedX = THREE.MathUtils.clamp(localX, 0, 1);
    const clampedY = THREE.MathUtils.clamp(localY, 0, 1);
    const chartX = clampedX * CHROMATICITY_MAX;
    const chartY = (1.0 - clampedY) * CHROMATICITY_MAX;
    chromaticityMatchHover.set(chartX, chartY);
  };

  const handlePointerDown = (event) => {
    updateHoverFromEvent(event);
    chromaticityMatch.copy(chromaticityMatchHover);
  };

  const handlePointerLeave = () => {
    chromaticityMatchHover.copy(chromaticityMatch);
  };

  canvas.addEventListener('pointermove', updateHoverFromEvent, { passive: false });
  canvas.addEventListener('pointerdown', handlePointerDown, { passive: false });
  canvas.addEventListener('pointerleave', handlePointerLeave);
  canvas.addEventListener('pointercancel', handlePointerLeave);
}

setupChromaticityPointerTracking(chromaticityCanvas);

function getPanelReferenceSize() {
  const rootStyles = getComputedStyle(document.documentElement);
  const parsed = parseFloat(rootStyles.getPropertyValue('--panel-size-reference'));
  return Number.isFinite(parsed) ? parsed : 640;
}

const lookupTableData = `0.213134,0.006387,0.997775
    0.208150,0.005981,0.997792
    0.203969,0.008723,0.997821
    0.200183,0.011988,0.997848
    0.196443,0.015307,0.997876
    0.192648,0.018562,0.997903
    0.188844,0.021807,0.997926
    0.185052,0.025066,0.997949
    0.181335,0.028410,0.997973
    0.177727,0.031871,0.997995
    0.174253,0.035467,0.998015
    0.170925,0.039198,0.998035
    0.167767,0.043075,0.998056
    0.164817,0.047112,0.998074
    0.162049,0.051275,0.998092
    0.159439,0.055540,0.998110
    0.156962,0.059883,0.998127
    0.154598,0.064289,0.998143
    0.152334,0.068747,0.998159
    0.150160,0.073249,0.998174
    0.148060,0.077787,0.998189
    0.146043,0.082362,0.998203
    0.144113,0.086974,0.998216
    0.142226,0.091605,0.998230
    0.140422,0.096268,0.998242
    0.138664,0.100948,0.998255
    0.136960,0.105649,0.998267
    0.135310,0.110369,0.998279
    0.133708,0.115105,0.998290
    0.132143,0.119854,0.998302
    0.130636,0.124621,0.998314
    0.129131,0.129389,0.998325
    0.127705,0.134182,0.998337
    0.126279,0.138974,0.998349
    0.124881,0.143774,0.998361
    0.123522,0.148586,0.998374
    0.122164,0.153398,0.998386
    0.120837,0.158219,0.998399
    0.119536,0.163046,0.998413
    0.118234,0.167874,0.998427
    0.116952,0.172707,0.998441
    0.115700,0.177547,0.998456
    0.114447,0.182388,0.998471
    0.113194,0.187228,0.998487
    0.111994,0.192082,0.998503
    0.110797,0.196937,0.998520
    0.109599,0.201791,0.998536
    0.108411,0.206648,0.998553
    0.107281,0.211518,0.998571
    0.106150,0.216389,0.998589
    0.105019,0.221259,0.998606
    0.103889,0.226130,0.998624
    0.102829,0.231016,0.998643
    0.101776,0.235904,0.998662
    0.100722,0.240791,0.998681
    0.099668,0.245679,0.998700
    0.098638,0.250572,0.998720
    0.097670,0.255477,0.998741
    0.096703,0.260383,0.998762
    0.095735,0.265288,0.998783
    0.094768,0.270193,0.998804
    0.093813,0.275101,0.998825
    0.092937,0.280024,0.998846
    0.092060,0.284946,0.998866
    0.091184,0.289869,0.998887
    0.090308,0.294792,0.998908
    0.089431,0.299714,0.998929
    0.088593,0.304643,0.998947
    0.087799,0.309580,0.998963
    0.087005,0.314516,0.998978
    0.086211,0.319453,0.998994
    0.085416,0.324389,0.999010
    0.084622,0.329326,0.999025
    0.083843,0.334265,0.999039
    0.083119,0.339212,0.999047
    0.082395,0.344159,0.999054
    0.081671,0.349106,0.999062
    0.080946,0.354054,0.999070
    0.080222,0.359001,0.999077
    0.079498,0.363948,0.999085
    0.078793,0.368898,0.999093
    0.078129,0.373854,0.999102
    0.077465,0.378809,0.999110
    0.076800,0.383765,0.999119
    0.076136,0.388721,0.999128
    0.075471,0.393676,0.999137
    0.074807,0.398632,0.999146
    0.074143,0.403588,0.999154
    0.073513,0.408548,0.999169
    0.072898,0.413510,0.999186
    0.072283,0.418472,0.999203
    0.071668,0.423434,0.999219
    0.071053,0.428396,0.999236
    0.070438,0.433358,0.999253
    0.069823,0.438320,0.999270
    0.069208,0.443282,0.999287
    0.068605,0.448245,0.999304
    0.068034,0.453213,0.999322
    0.067463,0.458180,0.999340
    0.066891,0.463147,0.999358
    0.066320,0.468114,0.999376
    0.065748,0.473081,0.999394
    0.065177,0.478049,0.999412
    0.064606,0.483016,0.999430
    0.064034,0.487983,0.999448
    0.063463,0.492950,0.999466
    0.062935,0.497922,0.999492
    0.062409,0.502894,0.999518
    0.061884,0.507867,0.999544
    0.061359,0.512839,0.999571
    0.060834,0.517811,0.999597
    0.060308,0.522784,0.999623
    0.059783,0.527756,0.999649
    0.059258,0.532728,0.999675
    0.058733,0.537700,0.999701
    0.058208,0.542673,0.999727
    0.057709,0.547648,0.999747
    0.057227,0.552624,0.999761
    0.056745,0.557601,0.999775
    0.056263,0.562578,0.999789
    0.055781,0.567554,0.999804
    0.055299,0.572531,0.999818
    0.054817,0.577508,0.999832
    0.054335,0.582485,0.999847
    0.053854,0.587461,0.999861
    0.053372,0.592438,0.999875
    0.052890,0.597415,0.999889
    0.052397,0.602371,0.999690
    0.051867,0.607253,0.998746
    0.051337,0.612134,0.997803
    0.050807,0.617016,0.996860
    0.050277,0.621897,0.995916
    0.049747,0.626779,0.994973
    0.049217,0.631660,0.994029
    0.048687,0.636542,0.993086
    0.048157,0.641423,0.992143
    0.047627,0.646305,0.991199
    0.047097,0.651187,0.990256
    0.046567,0.656068,0.989313
    0.046055,0.656600,0.984637
    0.045546,0.656768,0.979666
    0.045037,0.656936,0.974694
    0.044528,0.657104,0.969723
    0.044019,0.657272,0.964752
    0.043511,0.657439,0.959781
    0.043002,0.657607,0.954810
    0.042493,0.657775,0.949838
    0.041984,0.657943,0.944867
    0.041475,0.658111,0.939896
    0.040966,0.658279,0.934925
    0.040458,0.658447,0.929954
    0.039949,0.658615,0.924982
    0.039440,0.658783,0.920011
    0.038931,0.658951,0.915040
    0.038422,0.659118,0.910069
    0.037913,0.659286,0.905098
    0.037410,0.659456,0.900126
    0.036933,0.659636,0.895152
    0.036456,0.659815,0.890178
    0.035980,0.659995,0.885204
    0.035503,0.660175,0.880230
    0.035026,0.660355,0.875256
    0.034550,0.660534,0.870282
    0.034073,0.660714,0.865308
    0.033596,0.660894,0.860334
    0.033119,0.661073,0.855360
    0.032643,0.661253,0.850386
    0.032166,0.661433,0.845412
    0.031689,0.661613,0.840438
    0.031213,0.661792,0.835464
    0.030736,0.661972,0.830490
    0.030259,0.662152,0.825516
    0.029785,0.662332,0.820542
    0.029344,0.662525,0.815565
    0.028903,0.662718,0.810588
    0.028462,0.662910,0.805612
    0.028020,0.663103,0.800635
    0.027579,0.663296,0.795658
    0.027138,0.663489,0.790681
    0.026697,0.663681,0.785705
    0.026256,0.663874,0.780728
    0.025815,0.664067,0.775751
    0.025373,0.664260,0.770774
    0.024932,0.664452,0.765798
    0.024491,0.664645,0.760821
    0.024050,0.664838,0.755844
    0.023609,0.665030,0.750867
    0.023186,0.665230,0.745889
    0.022784,0.665437,0.740910
    0.022382,0.665644,0.735930
    0.021979,0.665851,0.730951
    0.021577,0.666058,0.725971
    0.021175,0.666265,0.720992
    0.020773,0.666472,0.716012
    0.020371,0.666679,0.711033
    0.019968,0.666886,0.706053
    0.019566,0.667093,0.701074
    0.019164,0.667300,0.696094
    0.018762,0.667507,0.691115
    0.018360,0.667714,0.686135
    0.017966,0.667924,0.681155
    0.017606,0.668146,0.676173
    0.017246,0.668369,0.671191
    0.016886,0.668591,0.666209
    0.016526,0.668814,0.661227
    0.016166,0.669036,0.656245
    0.015806,0.669258,0.651263
    0.015446,0.669481,0.646281
    0.015086,0.669703,0.641299
    0.014726,0.669926,0.636317
    0.014366,0.670148,0.631335
    0.014006,0.670371,0.626353
    0.013651,0.670595,0.621370
    0.013336,0.670834,0.616386
    0.013022,0.671073,0.611402
    0.012707,0.671312,0.606417
    0.012392,0.671550,0.601433
    0.012078,0.671789,0.596448
    0.011763,0.672028,0.591464
    0.011448,0.672267,0.586480
    0.011134,0.672506,0.581495
    0.010819,0.672745,0.576511
    0.010504,0.672984,0.571527
    0.010193,0.673224,0.566542
    0.009927,0.673481,0.561556
    0.009661,0.673738,0.556569
    0.009395,0.673994,0.551583
    0.009129,0.674251,0.546597
    0.008863,0.674508,0.541610
    0.008597,0.674764,0.536624
    0.008332,0.675021,0.531638
    0.008066,0.675278,0.526652
    0.007800,0.675534,0.521665
    0.007536,0.675792,0.516679
    0.007326,0.676069,0.511691
    0.007117,0.676346,0.506703
    0.006907,0.676623,0.501715
    0.006697,0.676901,0.496727
    0.006488,0.677178,0.491739
    0.006278,0.677455,0.486751
    0.006069,0.677732,0.481763
    0.005859,0.678009,0.476776
    0.005650,0.678286,0.471788
    0.005501,0.678585,0.466799
    0.005357,0.678886,0.461810
    0.005213,0.679187,0.456821
    0.005070,0.679488,0.451832
    0.004926,0.679789,0.446843
    0.004782,0.680091,0.441855
    0.004639,0.680392,0.436866
    0.004495,0.680693,0.431877
    0.004399,0.681011,0.426888
    0.004331,0.681339,0.421899
    0.004263,0.681667,0.416910
    0.004194,0.681995,0.411922
    0.004126,0.682324,0.406933
    0.004058,0.682652,0.401944
    0.003990,0.682980,0.396955
    0.003926,0.683310,0.391967
    0.003943,0.683669,0.386980
    0.003959,0.684028,0.381993
    0.003976,0.684386,0.377006
    0.003993,0.684745,0.372018
    0.004009,0.685104,0.367031
    0.004026,0.685463,0.362044
    0.004050,0.685824,0.357058
    0.004157,0.686215,0.352074
    0.004264,0.686606,0.347090
    0.004371,0.686998,0.342107
    0.004478,0.687389,0.337123
    0.004585,0.687780,0.332140
    0.004692,0.688171,0.327156
    0.004862,0.688585,0.322177
    0.005069,0.689012,0.317199
    0.005276,0.689438,0.312222
    0.005482,0.689865,0.307244
    0.005689,0.690292,0.302267
    0.005896,0.690719,0.297289
    0.006180,0.691173,0.292318
    0.006502,0.691640,0.287351
    0.006824,0.692108,0.282383
    0.007146,0.692576,0.277415
    0.007468,0.693044,0.272448
    0.007810,0.693518,0.267482
    0.008265,0.694033,0.262530
    0.008720,0.694547,0.257577
    0.009175,0.695062,0.252625
    0.009630,0.695577,0.247672
    0.010092,0.696094,0.242720
    0.010699,0.696662,0.237790
    0.011306,0.697230,0.232860
    0.011913,0.697798,0.227929
    0.012520,0.698366,0.222999
    0.013185,0.698954,0.218079
    0.013957,0.699580,0.213179
    0.014730,0.700205,0.208278
    0.015503,0.700831,0.203378
    0.016276,0.701457,0.198478
    0.017226,0.702144,0.193618
    0.018177,0.702831,0.188757
    0.019127,0.703518,0.183897
    0.020078,0.704205,0.179036
    0.021226,0.704960,0.174229
    0.022378,0.705715,0.169422
    0.023529,0.706471,0.164616
    0.024748,0.707250,0.159831
    0.026129,0.708083,0.155098
    0.027510,0.708917,0.150365
    0.028891,0.709750,0.145633
    0.030512,0.710664,0.140992
    0.032156,0.711585,0.136361
    0.033800,0.712506,0.131730
    0.035682,0.713506,0.127208
    0.037617,0.714523,0.122711
    0.039551,0.715540,0.118214
    0.041780,0.716651,0.113878
    0.044014,0.717764,0.109546
    0.046361,0.718913,0.105285
    0.048901,0.720123,0.101152
    0.051441,0.721332,0.097019
    0.054270,0.722631,0.093107
    0.057119,0.723935,0.089210
    0.060172,0.725300,0.085496
    0.063325,0.726695,0.081875
    0.066636,0.728135,0.078421
    0.070086,0.729615,0.075118
    0.073664,0.731129,0.071975
    0.077374,0.732679,0.069003
    0.081192,0.734257,0.066189
    0.085108,0.735859,0.063525
    0.089115,0.737484,0.061018
    0.093187,0.739124,0.058624
    0.097334,0.740780,0.056377
    0.101519,0.742445,0.054205
    0.105768,0.744123,0.052175
    0.110041,0.745806,0.050196
    0.114371,0.747499,0.048358
    0.118716,0.749196,0.046558
    0.123107,0.750900,0.044882
    0.127509,0.752606,0.043233
    0.131946,0.754318,0.041691
    0.136390,0.756030,0.040168
    0.140862,0.757747,0.038736
    0.145339,0.759464,0.037317
    0.149837,0.761183,0.035972
    0.154338,0.762903,0.034636
    0.158859,0.764625,0.033372
    0.163381,0.766347,0.032115
    0.167923,0.768071,0.030934
    0.172468,0.769795,0.029760
    0.177030,0.771520,0.028662
    0.181595,0.773246,0.027575
    0.186177,0.774972,0.026562
    0.190762,0.776698,0.025562
    0.195360,0.778425,0.024627
    0.199962,0.780152,0.023711
    0.204574,0.781878,0.022845
    0.209191,0.783605,0.022004
    0.213814,0.785331,0.021202
    0.218443,0.787057,0.020432
    0.223076,0.788783,0.019687
    0.227716,0.790508,0.018986
    0.232358,0.792233,0.018294
    0.237008,0.793958,0.017657
    0.241658,0.795682,0.017021
    0.246315,0.797405,0.016437
    0.250974,0.799128,0.015862
    0.255636,0.800850,0.015317
    0.260301,0.802572,0.014798
    0.264968,0.804293,0.014287
    0.269639,0.806013,0.013820
    0.274311,0.807733,0.013353
    0.278986,0.809452,0.012919
    0.283663,0.811170,0.012500
    0.288340,0.812889,0.012088
    0.293021,0.814605,0.011713
    0.297702,0.816322,0.011338
    0.302385,0.818038,0.010986
    0.307070,0.819754,0.010652
    0.311754,0.821469,0.010318
    0.316442,0.823183,0.010017
    0.321130,0.824897,0.009721
    0.325818,0.826611,0.009428
    0.330508,0.828323,0.009165
    0.335198,0.830035,0.008902
    0.339889,0.831747,0.008647
    0.344581,0.833458,0.008414
    0.349274,0.835169,0.008181
    0.353967,0.836880,0.007956
    0.358661,0.838589,0.007750
    0.363355,0.840299,0.007543
    0.368049,0.842009,0.007343
    0.372745,0.843717,0.007161
    0.377440,0.845426,0.006978
    0.382136,0.847134,0.006799
    0.386832,0.848841,0.006637
    0.391529,0.850549,0.006476
    0.396226,0.852256,0.006315
    0.400923,0.853963,0.006172
    0.405621,0.855669,0.006030
    0.410319,0.857376,0.005888
    0.415017,0.859082,0.005756
    0.419715,0.860787,0.005632
    0.424414,0.862493,0.005507
    0.429112,0.864198,0.005384
    0.433812,0.865903,0.005276
    0.438511,0.867607,0.005167
    0.443210,0.869312,0.005058
    0.447909,0.871016,0.004956
    0.452609,0.872720,0.004862
    0.457309,0.874424,0.004767
    0.462009,0.876128,0.004672
    0.466709,0.877831,0.004587
    0.471409,0.879534,0.004505
    0.476109,0.881238,0.004422
    0.480810,0.882941,0.004340
    0.485510,0.884643,0.004267
    0.490211,0.886346,0.004196
    0.494912,0.888049,0.004124
    0.499612,0.889751,0.004053
    0.504313,0.891453,0.003989
    0.509014,0.893155,0.003927
    0.513715,0.894857,0.003865
    0.518416,0.896559,0.003803
    0.523117,0.898261,0.003746
    0.527819,0.899962,0.003691
    0.532520,0.901664,0.003637
    0.537221,0.903366,0.003583
    0.541922,0.905067,0.003530
    0.546624,0.906768,0.003483
    0.551325,0.908469,0.003435
    0.556027,0.910170,0.003388
    0.560728,0.911872,0.003340
    0.565430,0.913572,0.003297
    0.570131,0.915273,0.003256
    0.574833,0.916974,0.003214
    0.579535,0.918675,0.003172
    0.584236,0.920376,0.003131
    0.588938,0.922076,0.003095
    0.593640,0.923777,0.003059
    0.598342,0.925477,0.003023
    0.603044,0.927177,0.002987
    0.607746,0.928878,0.002952
    0.612448,0.930578,0.002921
    0.617150,0.932278,0.002890
    0.621852,0.933978,0.002859
    0.626553,0.935678,0.002828
    0.631255,0.937379,0.002798
    0.635958,0.939079,0.002771
    0.640660,0.940778,0.002745
    0.645362,0.942478,0.002719
    0.650064,0.944178,0.002693
    0.654766,0.945878,0.002666
    0.659468,0.947578,0.002643
    0.664170,0.949277,0.002621
    0.668873,0.950977,0.002599
    0.673575,0.952677,0.002577
    0.678277,0.954376,0.002555
    0.682979,0.956076,0.002534
    0.687682,0.957775,0.002515
    0.692384,0.959474,0.002497
    0.697086,0.961174,0.002478
    0.701788,0.962873,0.002460
    0.706491,0.964573,0.002441
    0.711193,0.966272,0.002424
    0.715896,0.967971,0.002409
    0.720598,0.969670,0.002394
    0.725300,0.971370,0.002379
    0.730003,0.973069,0.002364
    0.734705,0.974768,0.002349
    0.739408,0.976467,0.002335
    0.744110,0.978166,0.002323
    0.748813,0.979865,0.002311
    0.753515,0.981564,0.002299
    0.758217,0.983263,0.002287
    0.762920,0.984962,0.002275
    0.767622,0.986661,0.002263
    0.772506,0.987730,0.002249
    0.777394,0.988782,0.002236
    0.782282,0.989834,0.002223
    0.787170,0.990886,0.002209
    0.792058,0.991937,0.002196
    0.796498,0.990739,0.002175
    0.800295,0.987486,0.002148
    0.804092,0.984233,0.002120
    0.807888,0.980979,0.002093
    0.811633,0.977666,0.002070
    0.815378,0.974354,0.002047
    0.819123,0.971041,0.002024
    0.822663,0.967519,0.002002
    0.825996,0.963792,0.001982
    0.829329,0.960065,0.001962
    0.832662,0.956338,0.001941
    0.835382,0.952144,0.001923
    0.838083,0.947936,0.001905
    0.840784,0.943729,0.001888
    0.843331,0.939431,0.001870
    0.845591,0.934971,0.001855
    0.847852,0.930512,0.001839
    0.850113,0.926052,0.001823
    0.852172,0.921498,0.001809
    0.854125,0.916895,0.001795
    0.856079,0.912293,0.001782
    0.858032,0.907690,0.001768
    0.859776,0.903004,0.001756
    0.861501,0.898311,0.001744
    0.863225,0.893618,0.001731
    0.864923,0.888916,0.001719
    0.866471,0.884161,0.001708
    0.868018,0.879407,0.001696
    0.869566,0.874652,0.001685
    0.871061,0.869881,0.001673
    0.872476,0.865086,0.001661
    0.873891,0.860290,0.001649
    0.875305,0.855495,0.001637
    0.876665,0.850683,0.001625
    0.877997,0.845864,0.001612
    0.879329,0.841044,0.001599
    0.880661,0.836225,0.001586
    0.881933,0.831390,0.001571
    0.883206,0.826554,0.001557
    0.884478,0.821719,0.001542
    0.885729,0.816878,0.001527
    0.886946,0.812029,0.001511
    0.888164,0.807179,0.001495
    0.889381,0.802329,0.001479
    0.890551,0.797468,0.001462
    0.891711,0.792605,0.001445
    0.892871,0.787741,0.001427
    0.894012,0.782873,0.001410
    0.895117,0.777997,0.001391
    0.896221,0.773121,0.001373
    0.897326,0.768244,0.001355
    0.898384,0.763357,0.001336
    0.899438,0.758470,0.001316
    0.900492,0.753582,0.001297
    0.901498,0.748685,0.001277
    0.902469,0.743780,0.001256
    0.903441,0.738875,0.001236
    0.904401,0.733968,0.001215
    0.905335,0.729056,0.001193
    0.906268,0.724144,0.001172
    0.907196,0.719231,0.001150
    0.908072,0.714309,0.001129
    0.908948,0.709386,0.001108
    0.909825,0.704463,0.001087
    0.910656,0.699533,0.001068
    0.911487,0.694603,0.001048
    0.912318,0.689672,0.001029
    0.913115,0.684736,0.001013
    0.913909,0.679800,0.000997
    0.914703,0.674863,0.000981
    0.915467,0.669922,0.000969
    0.916230,0.664980,0.000958
    0.916990,0.660039,0.000947
    0.917714,0.655091,0.000940
    0.918439,0.650144,0.000932
    0.919163,0.645197,0.000925
    0.919887,0.640250,0.000919
    0.920612,0.635302,0.000913
    0.921303,0.630350,0.000907
    0.921970,0.625395,0.000901
    0.922637,0.620440,0.000895
    0.923301,0.615484,0.000887
    0.923966,0.610529,0.000879
    0.924630,0.605573,0.000869
    0.925294,0.600617,0.000857
    0.925955,0.595661,0.000845
    0.926575,0.590700,0.000830
    0.927194,0.585738,0.000815
    0.927810,0.580776,0.000799
    0.928425,0.575814,0.000782
    0.929040,0.570852,0.000764
    0.929655,0.565890,0.000746
    0.930270,0.560928,0.000729
    0.930885,0.555966,0.000711
    0.931481,0.551002,0.000694
    0.932053,0.546035,0.000678
    0.932624,0.541068,0.000662
    0.933196,0.536100,0.000646
    0.933768,0.531133,0.000629
    0.934339,0.526166,0.000612
    0.934911,0.521199,0.000594
    0.935482,0.516232,0.000576
    0.936053,0.511264,0.000554
    0.936613,0.506296,0.000530
    0.937143,0.501324,0.000503
    0.937670,0.496352,0.000473
    0.938194,0.491380,0.000442
    0.938719,0.486407,0.000409
    0.939243,0.481435,0.000376
    0.939768,0.476463,0.000346
    0.940293,0.471491,0.000318
    0.940819,0.466518,0.000296
    0.941345,0.461546,0.000279
    0.941865,0.456573,0.000265
    0.942365,0.451598,0.000255
    0.942847,0.446622,0.000246
    0.943330,0.441645,0.000239
    0.943813,0.436668,0.000233
    0.944296,0.431692,0.000227
    0.944778,0.426715,0.000221
    0.945261,0.421738,0.000211
    0.945742,0.416762,0.000193
    0.946223,0.411785,0.000167
    0.946703,0.406808,0.000139
    0.947184,0.401831,0.000113
    0.947648,0.396853,0.000092
    0.948086,0.391872,0.000076
    0.948524,0.386891,0.000063
    0.948962,0.381911,0.000055
    0.949401,0.376930,0.000049
    0.949839,0.371949,0.000043
    0.950277,0.366968,0.000035
    0.950715,0.361988,0.000016
    0.951152,0.357007,-0.000000
    0.951591,0.352026,0.000000
    0.952031,0.347046,0.000000
    0.952529,0.343827,0.002091
    0.953052,0.343665,0.007061
    0.953575,0.343502,0.012031
    0.954098,0.343339,0.017001
    0.954621,0.343177,0.021971
    0.955130,0.343009,0.026942
    0.955639,0.342841,0.031913
    0.956148,0.342673,0.036884
    0.956657,0.342505,0.041856
    0.957166,0.342337,0.046827
    0.957675,0.342169,0.051798
    0.958183,0.342002,0.056769
    0.958692,0.341834,0.061740
    0.959201,0.341666,0.066712
    0.959710,0.341498,0.071683
    0.960219,0.341330,0.076654
    0.960728,0.341162,0.081625
    0.961237,0.340994,0.086596
    0.961745,0.340826,0.091568
    0.962238,0.340653,0.096540
    0.962722,0.340476,0.101514
    0.963206,0.340298,0.106487
    0.963690,0.340121,0.111460
    0.964174,0.339944,0.116434
    0.964654,0.339766,0.121407
    0.965131,0.339586,0.126381
    0.965607,0.339407,0.131355
    0.966084,0.339227,0.136329
    0.966561,0.339047,0.141303
    0.967037,0.338867,0.146277
    0.967514,0.338688,0.151251
    0.967991,0.338508,0.156225
    0.968467,0.338328,0.161199
    0.968944,0.338149,0.166173
    0.969421,0.337969,0.171147
    0.969882,0.337783,0.176122
    0.970330,0.337593,0.181099
    0.970778,0.337403,0.186075
    0.971227,0.337213,0.191051
    0.971675,0.337023,0.196027
    0.972123,0.336833,0.201004
    0.972566,0.336641,0.205980
    0.973007,0.336448,0.210957
    0.973448,0.336255,0.215934
    0.973889,0.336062,0.220911
    0.974331,0.335870,0.225887
    0.974772,0.335677,0.230864
    0.975202,0.335480,0.235842
    0.975629,0.335282,0.240820
    0.976055,0.335084,0.245797
    0.976482,0.334886,0.250775
    0.976908,0.334688,0.255753
    0.977335,0.334490,0.260731
    0.977751,0.334288,0.265709
    0.978153,0.334081,0.270689
    0.978555,0.333874,0.275668
    0.978957,0.333667,0.280648
    0.979360,0.333460,0.285627
    0.979762,0.333253,0.290607
    0.980164,0.333046,0.295586
    0.980553,0.332834,0.300567
    0.980940,0.332622,0.305547
    0.981327,0.332409,0.310528
    0.981714,0.332196,0.315508
    0.982101,0.331984,0.320489
    0.982488,0.331771,0.325469
    0.982873,0.331558,0.330450
    0.983233,0.331336,0.335432
    0.983593,0.331113,0.340414
    0.983953,0.330891,0.345396
    0.984313,0.330668,0.350378
    0.984673,0.330446,0.355360
    0.985032,0.330223,0.360342
    0.985392,0.330001,0.365324
    0.985724,0.329768,0.370308
    0.986054,0.329535,0.375291
    0.986384,0.329302,0.380275
    0.986714,0.329068,0.385259
    0.987044,0.328835,0.390242
    0.987374,0.328602,0.395226
    0.987704,0.328368,0.400209
    0.988021,0.328130,0.405194
    0.988325,0.327887,0.410179
    0.988630,0.327645,0.415163
    0.988935,0.327402,0.420148
    0.989239,0.327160,0.425133
    0.989544,0.326917,0.430118
    0.989849,0.326674,0.435103
    0.990153,0.326432,0.440087
    0.990426,0.326178,0.445073
    0.990692,0.325921,0.450060
    0.990958,0.325664,0.455046
    0.991224,0.325408,0.460032
    0.991490,0.325151,0.465019
    0.991756,0.324894,0.470005
    0.992022,0.324638,0.474991
    0.992288,0.324381,0.479978
    0.992513,0.324109,0.484965
    0.992725,0.323833,0.489953
    0.992938,0.323557,0.494941
    0.993150,0.323281,0.499929
    0.993362,0.323005,0.504917
    0.993574,0.322728,0.509904
    0.993786,0.322452,0.514892
    0.993999,0.322176,0.519880
    0.994188,0.321892,0.524868
    0.994340,0.321594,0.529857
    0.994493,0.321296,0.534846
    0.994645,0.320998,0.539835
    0.994797,0.320700,0.544824
    0.994949,0.320402,0.549812
    0.995101,0.320104,0.554801
    0.995253,0.319806,0.559790
    0.995406,0.319508,0.564779
    0.995502,0.319190,0.569768
    0.995569,0.318861,0.574756
    0.995636,0.318533,0.579745
    0.995703,0.318204,0.584734
    0.995770,0.317875,0.589722
    0.995837,0.317547,0.594711
    0.995904,0.317218,0.599700
    0.995971,0.316889,0.604689
    0.996038,0.316561,0.609677
    0.996033,0.316206,0.614665
    0.995986,0.315836,0.619651
    0.995940,0.315467,0.624637
    0.995893,0.315097,0.629623
    0.995847,0.314728,0.634609
    0.995800,0.314358,0.639595
    0.995753,0.313989,0.644581
    0.995707,0.313619,0.649567
    0.995660,0.313250,0.654553
    0.995572,0.312865,0.659537
    0.995397,0.312450,0.664517
    0.995223,0.312035,0.669497
    0.995048,0.311619,0.674476
    0.994873,0.311204,0.679456
    0.994699,0.310789,0.684436
    0.994524,0.310373,0.689415
    0.994349,0.309958,0.694395
    0.994174,0.309543,0.699375
    0.994000,0.309127,0.704354
    0.993668,0.308656,0.709320
    0.993285,0.308167,0.714281
    0.992902,0.307678,0.719243
    0.992519,0.307189,0.724204
    0.992136,0.306699,0.729165
    0.991754,0.306210,0.734127
    0.991371,0.305721,0.739088
    0.990988,0.305232,0.744049
    0.990605,0.304743,0.749010
    0.990212,0.304250,0.753970
    0.989539,0.303659,0.758889
    0.988867,0.303068,0.763808
    0.988194,0.302477,0.768728
    0.987521,0.301886,0.773647
    0.986848,0.301295,0.778566
    0.986175,0.300704,0.783485
    0.985503,0.300114,0.788404
    0.984830,0.299523,0.793323
    0.984157,0.298932,0.798243
    0.983360,0.298298,0.803134
    0.982244,0.297554,0.807950
    0.981128,0.296810,0.812767
    0.980012,0.296067,0.817584
    0.978896,0.295323,0.822401
    0.977780,0.294579,0.827217
    0.976664,0.293835,0.832034
    0.975547,0.293092,0.836851
    0.974431,0.292348,0.841668
    0.973315,0.291604,0.846484
    0.971724,0.290701,0.851125
    0.969906,0.289722,0.855678
    0.968087,0.288744,0.860232
    0.966269,0.287765,0.864785
    0.964450,0.286786,0.869339
    0.962632,0.285807,0.873892
    0.960813,0.284828,0.878446
    0.958995,0.283850,0.883000
    0.957176,0.282871,0.887553
    0.954898,0.281747,0.891815
    0.952002,0.280428,0.895671
    0.949105,0.279109,0.899527
    0.946208,0.277790,0.903383
    0.943311,0.276471,0.907239
    0.940414,0.275152,0.911095
    0.937517,0.273834,0.914951
    0.934620,0.272515,0.918807
    0.931724,0.271196,0.922663
    0.928231,0.269711,0.925819
    0.924262,0.268096,0.928395
    0.920293,0.266480,0.930971
    0.916324,0.264865,0.933547
    0.912355,0.263249,0.936123
    0.908385,0.261634,0.938699
    0.904416,0.260018,0.941276
    0.900447,0.258403,0.943852
    0.896478,0.256787,0.946428
    0.892283,0.255124,0.948524
    0.887880,0.253418,0.950169
    0.883478,0.251711,0.951814
    0.879075,0.250005,0.953459
    0.874672,0.248299,0.955104
    0.870270,0.246593,0.956749
    0.865867,0.244887,0.958394
    0.861465,0.243180,0.960039
    0.857062,0.241474,0.961684
    0.852642,0.239766,0.963271
    0.848098,0.238042,0.964445
    0.843553,0.236318,0.965619
    0.839009,0.234594,0.966792
    0.834465,0.232869,0.967966
    0.829921,0.231145,0.969140
    0.825376,0.229421,0.970313
    0.820832,0.227697,0.971487
    0.816288,0.225973,0.972661
    0.811744,0.224249,0.973834
    0.807146,0.222524,0.974759
    0.802524,0.220797,0.975569
    0.797902,0.219071,0.976379
    0.793280,0.217344,0.977190
    0.788658,0.215618,0.978000
    0.784036,0.213892,0.978810
    0.779414,0.212165,0.979620
    0.774792,0.210439,0.980430
    0.770170,0.208712,0.981241
    0.765534,0.206987,0.981964
    0.760872,0.205265,0.982510
    0.756210,0.203543,0.983055
    0.751548,0.201821,0.983600
    0.746885,0.200098,0.984145
    0.742223,0.198376,0.984691
    0.737561,0.196654,0.985236
    0.732899,0.194932,0.985781
    0.728236,0.193210,0.986326
    0.723571,0.191488,0.986842
    0.718889,0.189772,0.987208
    0.714207,0.188055,0.987574
    0.709525,0.186339,0.987941
    0.704844,0.184622,0.988307
    0.700162,0.182905,0.988674
    0.695480,0.181189,0.989040
    0.690798,0.179472,0.989406
    0.686116,0.177756,0.989773
    0.681432,0.176040,0.990104
    0.676741,0.174329,0.990357
    0.672050,0.172617,0.990610
    0.667359,0.170905,0.990863
    0.662668,0.169193,0.991117
    0.657977,0.167481,0.991370
    0.653286,0.165769,0.991623
    0.648595,0.164057,0.991876
    0.643904,0.162345,0.992130
    0.639209,0.160636,0.992323
    0.634514,0.158928,0.992504
    0.629818,0.157219,0.992686
    0.625123,0.155511,0.992867
    0.620427,0.153802,0.993048
    0.615731,0.152094,0.993230
    0.611036,0.150385,0.993411
    0.606340,0.148677,0.993592
    0.601643,0.146970,0.993737
    0.596945,0.145264,0.993870
    0.592247,0.143558,0.994003
    0.587549,0.141852,0.994135
    0.582850,0.140146,0.994268
    0.578152,0.138440,0.994401
    0.573454,0.136734,0.994534
    0.568756,0.135029,0.994664
    0.564057,0.133324,0.994764
    0.559357,0.131620,0.994864
    0.554657,0.129916,0.994964
    0.549958,0.128212,0.995064
    0.545258,0.126508,0.995164
    0.540559,0.124804,0.995264
    0.535859,0.123100,0.995364
    0.531159,0.121396,0.995446
    0.526458,0.119693,0.995523
    0.521758,0.117991,0.995600
    0.517058,0.116288,0.995677
    0.512357,0.114585,0.995753
    0.507657,0.112882,0.995830
    0.502956,0.111179,0.995907
    0.498255,0.109477,0.995970
    0.493554,0.107775,0.996031
    0.488853,0.106073,0.996092
    0.484152,0.104371,0.996153
    0.479451,0.102669,0.996213
    0.474750,0.100967,0.996274
    0.470049,0.099266,0.996332
    0.465347,0.097564,0.996382
    0.460646,0.095863,0.996433
    0.455945,0.094162,0.996483
    0.451243,0.092460,0.996533
    0.446542,0.090759,0.996584
    0.441841,0.089058,0.996634
    0.437139,0.087357,0.996676
    0.432437,0.085656,0.996718
    0.427736,0.083955,0.996760
    0.423034,0.082255,0.996802
    0.418332,0.080554,0.996844
    0.413631,0.078853,0.996885
    0.408929,0.077153,0.996920
    0.404227,0.075452,0.996955
    0.399525,0.073752,0.996990
    0.394823,0.072051,0.997025
    0.390121,0.070351,0.997060
    0.385419,0.068651,0.997093
    0.380717,0.066951,0.997122
    0.376015,0.065251,0.997152
    0.371313,0.063551,0.997181
    0.366611,0.061850,0.997211
    0.361909,0.060150,0.997241
    0.357207,0.058451,0.997266
    0.352505,0.056751,0.997291
    0.347803,0.055051,0.997316
    0.343101,0.053351,0.997341
    0.338399,0.051651,0.997366
    0.333697,0.049952,0.997388
    0.328994,0.048252,0.997410
    0.324292,0.046553,0.997432
    0.319590,0.044853,0.997453
    0.314888,0.043153,0.997475
    0.310185,0.041454,0.997493
    0.305483,0.039755,0.997512
    0.300781,0.038055,0.997530
    0.296078,0.036356,0.997549
    0.291376,0.034657,0.997566
    0.286674,0.032957,0.997582
    0.281971,0.031258,0.997597
    0.277269,0.029559,0.997612
    0.272567,0.027860,0.997628
    0.267864,0.026161,0.997642
    0.263162,0.024461,0.997655
    0.258459,0.022762,0.997669
    0.253757,0.021063,0.997682
    0.249054,0.019364,0.997695
    0.244352,0.017665,0.997707
    0.239649,0.015966,0.997719
    0.234947,0.014267,0.997731
    0.230244,0.012568,0.997742
    0.225542,0.010870,0.997751
    0.220839,0.009171,0.997760
    0.216137,0.007472,0.997769`;
const lookupTable = new Float32Array(
  lookupTableData
    .trim()
    .split(/[\s,]+/)
    .filter(Boolean)
    .map(Number)
);
const spectrumTextures = createComplementSpectrumTextures();

const GLSL_CLOUD_UTILS = /* glsl */ `
float rand(vec2 co) {
  return fract(sin(dot(co, vec2(12.9898, 78.233))) * 43758.5453);
}

float stable_randomizer(vec3 starter) {
  float r1 = rand(vec2(starter.x * 1502.13, starter.y * 232.82 + starter.z * 800.1));
  float r2 = rand(vec2(starter.y * 545.36, starter.z * 646.2 + r1 * 250.0));
  float r3 = rand(vec2(starter.x * 1408.33, starter.z * 257.9 + r2 * 630.0));

  float p1 = rand(vec2(starter.x * 100.2 + 50.0 * r1, starter.y * 17.6));
  float p2 = rand(vec2(starter.y * 256.4 + 67.8 * r2, starter.z * 179.5));
  float p3 = rand(vec2(starter.z * 98.3 + 98.0 * r3, starter.x * 290.5));

  return rand(vec2(89.8 * p1, rand(vec2(107.9 * p2, 56.03 * p3))));
}

vec3 randomizer(vec3 starter, float time, bool edge) {
  float r1 = rand(vec2(starter.x * 1502.13, starter.y * 232.82 + starter.z * 800.1));
  float r2 = rand(vec2(starter.y * 545.36, starter.z * 646.2 + r1 * 250.0));
  float r3 = rand(vec2(starter.x * 1408.33, starter.z * 257.9 + r2 * 630.0));

  float speed = 1.0 / 1000.0;

  float p1 = (r1 * sin((0.5 + 1.5 * r2) * time * speed + 150.0 * rand(vec2(starter.x * 100.2 + 50.0 * r1, starter.y * 17.6))) + 1.0) * 0.5;
  float p2 = (r2 * sin((0.5 + 1.5 * r3) * time * speed + 276.0 * rand(vec2(starter.y * 256.4 + 67.8 * r2, starter.z * 179.5))) + 1.0) * 0.5;
  float p3 = (r3 * sin((0.5 + 1.5 * r1) * time * speed + 2039.0 * rand(vec2(starter.z * 98.3 + 98.0 * r3, starter.x * 290.5))) + 1.0) * 0.5;

  if (edge) {
    speed = 1.0 / 10000.0;
    p1 = ((sin((0.5 + 1.5 * r2) * time * speed + 150.0 * rand(vec2(starter.x * 100.2 + 50.0 * r1, starter.y * 17.6))) * 2.0) * 0.5 + 1.0) * 0.5;
    p2 = ((sin((0.5 + 1.5 * r3) * time * speed + 276.0 * rand(vec2(starter.y * 256.4 + 67.8 * r2, starter.z * 179.5))) * 2.0) * 0.5 + 1.0) * 0.5;
    p3 = ((sin((0.5 + 1.5 * r1) * time * speed + 2039.0 * rand(vec2(starter.z * 98.3 + 98.0 * r3, starter.x * 290.5))) * 2.0) * 0.5 + 1.0) * 0.5;
  }

  return vec3(p1, p2, p3);
}

float adjustDensity(float x, float A_prime, float B_prime, float S) {
  float B = (B_prime - A_prime) / S + A_prime * (1.0 - (1.0 - S) * (B_prime - A_prime));
  float A = A_prime * (1.0 - (1.0 - S) * (B - A_prime));

  if (x < A) {
    return (A_prime / A) * x;
  } else if (x < B) {
    return A_prime + S * (x - A);
  } else {
    return B_prime + (1.0 - B_prime) / (1.0 - B) * (x - B);
  }
}

vec3 cylindricalCloudDistribute(vec3 pos, float time) {
  float strength = 1.0 / 16.0;
  float r = stable_randomizer(pos);
  bool edge = false;
  if (r < 0.5) {
    strength = 1.0;
    edge = true;
  }

  vec3 new_point = randomizer(pos, time, edge);
  return mod(vec3(stable_randomizer(pos), 0.0, 0.0) + mix(pos.xyz, new_point, strength), 1.0);
}

vec3 cubicCloudDistribute(vec3 pos, float time) {
  float strength = 1.0 / 16.0;
  float r = stable_randomizer(pos);
  bool edge = false;
  if (r < 0.5) {
    strength = 1.0;
    edge = true;
  }

  vec3 new_point = randomizer(pos, time, edge);
  return mix(pos.xyz, new_point, strength);
}



mat3 rotationX(float angle) {
  float s = sin(angle);
  float c = cos(angle);
  return mat3(
    1.0, 0.0, 0.0,
    0.0, c, -s,
    0.0, s,  c
  );
}

mat3 rotationY(float angle) {
  float s = sin(angle);
  float c = cos(angle);
  return mat3(
     c, 0.0, s,
     0.0, 1.0, 0.0,
    -s, 0.0, c
  );
}

mat3 rotationZ(float angle) {
  float s = sin(angle);
  float c = cos(angle);
  return mat3(
    c, -s, 0.0,
    s,  c, 0.0,
    0.0, 0.0, 1.0
  );
}

vec3 positionInDisplaySpace(vec3 coord, float scale) {
  const vec3 axisY = normalize(vec3(1.0, 1.0, 1.0));
  const vec3 axisX = normalize(vec3(1.0, -1.0, 0.0));
  const vec3 axisZ = normalize(cross(axisY, axisX));
  const float diagScale = inversesqrt(3.0);

  vec3 centered = coord - vec3(0.5);
  vec3 rotated = vec3(
    dot(centered, axisX),
    dot(centered, axisY) * diagScale,
    - dot(centered, axisZ)
  );

  return 1.45 * scale * rotated;
}

vec3 positionChromaticity(vec3 coord, float scale) {
  float sum = max(coord.x + coord.y + coord.z, 1e-5);
  vec2 chroma = coord.xy / sum;

  vec2 clamped = clamp(chroma, 0.0, 0.9);
  return vec3(clamped * scale, 0.0);
}

vec3 pushIntoDisplayableXYZCloud(
  sampler2D texX,
  sampler2D texY,
  sampler2D texZ,
  vec3 distribution,
  float width
) {
  float redistribution = distribution.x * 2.0;
  float a1 = 0.001 * 2.0;
  float a2 = 0.143 * 2.0;
  float addit = floor(redistribution);
  redistribution = redistribution - addit;
  redistribution = adjustDensity(redistribution, a1, a2, 0.675) + addit;
  redistribution = redistribution / 2.0;

  vec3 value = vec3(
    texture2D(texX, vec2(redistribution, 0.5)).r,
    texture2D(texY, vec2(redistribution, 0.5)).r,
    texture2D(texZ, vec2(redistribution, 0.5)).r
  );
  return mix(value, vec3(distribution.y), distribution.z);
}
`;
const syncPointSizeValue = (value) => {
  if (pointSizeValueLabel) {
    pointSizeValueLabel.textContent = value.toFixed(1);
  }
};

const resolveCheckbox = (input, fallback) => {
  if (!input) {
    return fallback;
  }
  return input.checked;
};

const chromaticityViewer = createCloudViewer({
  canvas: chromaticityCanvas,
  placementMode: 'chromaticity',
});

const spaceViewer = createCloudViewer({
  canvas: spaceCanvas,
  placementMode: 'display',
});

viewers.push(chromaticityViewer, spaceViewer);

const applyPointSize = (value) => {
  syncPointSizeValue(value);
  for (const viewer of viewers) {
    viewer.setPointSize(value);
  }
};

applyPointSize(initialPointSizeValue);

if (pointSizeSlider) {
  pointSizeSlider.addEventListener('input', () => {
    const value = parseFloat(pointSizeSlider.value);
    if (!Number.isFinite(value)) {
      return;
    }
    applyPointSize(value);
  });
}

const updateCloudVisibility = () => {
  const maxEnabled = resolveCheckbox(toggleMaxGamut, true);
  const p3Enabled = resolveCheckbox(toggleP3, true);
  const srgbEnabled = resolveCheckbox(toggleSRGB, true);

  for (const viewer of viewers) {
    viewer.setVisibility(maxEnabled, p3Enabled, srgbEnabled);
  }
};

if (toggleMaxGamut) {
  toggleMaxGamut.addEventListener('change', updateCloudVisibility);
}
if (toggleP3) {
  toggleP3.addEventListener('change', updateCloudVisibility);
}
if (toggleSRGB) {
  toggleSRGB.addEventListener('change', updateCloudVisibility);
}

updateCloudVisibility();

function tick() {
  const elapsedMs = clock.getElapsedTime() * 1000.0;
  for (const viewer of viewers) {
    viewer.updateTime(elapsedMs);
    viewer.render();
  }
  requestAnimationFrame(tick);
}

tick();

function createCloudViewer({ canvas, placementMode }) {
  if (!canvas) {
    throw new Error('Canvas element is required to create a viewer.');
  }

  const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.toneMapping = THREE.NoToneMapping;
  renderer.setClearAlpha(0);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
  if ('outputColorSpace' in renderer && THREE.DisplayP3ColorSpace) {
    renderer.outputColorSpace = THREE.DisplayP3ColorSpace;
  }
  if (renderer.domElement.style) {
    renderer.domElement.style.colorSpace = 'display-p3';
  }

  const scene = new THREE.Scene();
  scene.background = null;

  const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 20);
  camera.position.set(0, 0, 6);
  camera.lookAt(0, 0, 0);

  const geometry = buildPointCloudGeometry();
  const maxDrawRange = geometry.getAttribute('position').count;

  const generalMaterial = createPointCloudMaterial(
    spectrumTextures,
    initialPointSizeValue,
    placementMode,
    chromaticityMatch,
    chromaticityMatchHover
  );
  const p3Material = createP3PointCloudMaterial(
    initialPointSizeValue,
    placementMode,
    chromaticityMatch,
    chromaticityMatchHover
  );
  const srgbMaterial = createSRGBPointCloudMaterial(
    initialPointSizeValue,
    placementMode,
    chromaticityMatch,
    chromaticityMatchHover
  );

  geometry.setDrawRange(0, maxDrawRange);

  const generalPoints = new THREE.Points(geometry, generalMaterial);
  const p3Points = new THREE.Points(geometry, p3Material);
  const srgbPoints = new THREE.Points(geometry, srgbMaterial);

  const group = new THREE.Group();
  group.add(generalPoints);
  group.add(p3Points);
  group.add(srgbPoints);
  group.scale.setScalar(1.0);
  group.rotation.set(0, 0, 0);

  scene.add(group);

  const rotationState =
    placementMode === 'display'
      ? {
          isDragging: false,
          pointerId: null,
          lastX: 0,
          lastY: 0,
          velocity: new THREE.Vector2(),
        }
      : null;

  if (rotationState) {
    const ROTATION_ACCEL = 0.01;
    const FRICTION = 0.966;
    const MAX_TILT = Math.PI * 0.5;

    const handlePointerDown = (event) => {
      event.preventDefault();
      rotationState.isDragging = true;
      rotationState.pointerId = event.pointerId;
      rotationState.lastX = event.clientX;
      rotationState.lastY = event.clientY;
      rotationState.velocity.set(0, 0);
      canvas.setPointerCapture(event.pointerId);
    };

    const handlePointerMove = (event) => {
      if (!rotationState.isDragging || event.pointerId !== rotationState.pointerId) {
        return;
      }
      event.preventDefault();

      const dx = event.clientX - rotationState.lastX;
      const dy = event.clientY - rotationState.lastY;
      rotationState.lastX = event.clientX;
      rotationState.lastY = event.clientY;

      const deltaYaw = dx * ROTATION_ACCEL;
      const deltaPitch = dy * ROTATION_ACCEL;

      group.rotation.y += deltaYaw;
      const nextPitch = THREE.MathUtils.clamp(group.rotation.x + deltaPitch, -MAX_TILT, MAX_TILT);
      group.rotation.x = nextPitch;

      rotationState.velocity.set(deltaPitch, deltaYaw);
    };

    const handlePointerUp = (event) => {
      if (event.pointerId !== rotationState.pointerId) {
        return;
      }
      event.preventDefault();
      rotationState.isDragging = false;
      rotationState.pointerId = null;
      canvas.releasePointerCapture(event.pointerId);

      if (rotationState.velocity.lengthSq() < 1e-7) {
        rotationState.velocity.set(0, 0);
      }
    };

    canvas.addEventListener('pointerdown', handlePointerDown, { passive: false });
    canvas.addEventListener('pointermove', handlePointerMove, { passive: false });
    canvas.addEventListener('pointerup', handlePointerUp, { passive: false });
    canvas.addEventListener('pointerleave', handlePointerUp, { passive: false });
    canvas.addEventListener('pointercancel', handlePointerUp, { passive: false });

    rotationState.applyMomentum = () => {
      if (rotationState.isDragging) {
        return;
      }
      if (rotationState.velocity.lengthSq() < 1e-7) {
        rotationState.velocity.set(0, 0);
        return;
      }

      group.rotation.y += rotationState.velocity.y;
      const nextPitch = THREE.MathUtils.clamp(
        group.rotation.x + rotationState.velocity.x,
        -MAX_TILT,
        MAX_TILT
      );
      group.rotation.x = nextPitch;

      rotationState.velocity.multiplyScalar(FRICTION);
      if (rotationState.velocity.lengthSq() < 1e-7) {
        rotationState.velocity.set(0, 0);
      }
    };
  }

  const BASE_SIZE = getPanelReferenceSize();
  let lastCanvasWidth = 0;
  let lastCanvasHeight = 0;

  const updateCameraBounds = (width, height) => {
    if (placementMode === 'chromaticity') {
      camera.left = 0.0;
      camera.right = 0.9;
      camera.top = 0.9;
      camera.bottom = 0.0;
    } else {
      const aspect = width / height;
      const view = 1.1;
      camera.top = view;
      camera.bottom = -view;
      camera.left = -view * aspect;
      camera.right = view * aspect;
    }
    camera.updateProjectionMatrix();
  };

  const resize = () => {
    const width = Math.max(1, Math.round(canvas.clientWidth));
    const height = Math.max(1, Math.round(canvas.clientHeight));

    if (width === lastCanvasWidth && height === lastCanvasHeight) {
      return;
    }

    lastCanvasWidth = width;
    lastCanvasHeight = height;

    renderer.setSize(width, height, false);
    updateCameraBounds(width, height);

    const areaRatio = Math.pow((width * height) / (BASE_SIZE * BASE_SIZE), 0.5);
    const drawCount = Math.max(1, Math.floor(maxDrawRange * Math.min(1.0, areaRatio)));
    geometry.setDrawRange(0, drawCount);
  };

  resize();
  window.addEventListener('resize', resize);
  if (typeof ResizeObserver !== 'undefined') {
    const observer = new ResizeObserver(() => resize());
    observer.observe(canvas);
  }

  return {
    setPointSize(value) {
      generalMaterial.uniforms.uPointSize.value = value;
      p3Material.uniforms.uPointSize.value = value;
      srgbMaterial.uniforms.uPointSize.value = value;
    },
    setVisibility(maxEnabled, p3Enabled, srgbEnabled) {
      generalPoints.visible = maxEnabled;
      p3Points.visible = p3Enabled;
      srgbPoints.visible = srgbEnabled;
      generalMaterial.uniforms.uP3Enabled.value = p3Enabled;
      generalMaterial.uniforms.uSRGBEnabled.value = srgbEnabled;
      generalMaterial.uniforms.uShowCube.value = maxEnabled && (p3Enabled || srgbEnabled);
    },
    updateTime(elapsedMs) {
      generalMaterial.uniforms.uTime.value = elapsedMs;
      p3Material.uniforms.uTime.value = elapsedMs;
      srgbMaterial.uniforms.uTime.value = elapsedMs;
    },
    render() {
      if (rotationState?.applyMomentum) {
        rotationState.applyMomentum();
      }
      renderer.render(scene, camera);
    },
    resize,
  };
}

function buildPointCloudGeometry() {
  const steps = 40;
  const total = steps * steps * steps;
  const triples = [];
  const margin = 1 / (steps * 2);
  const scale = 1 - 2 * margin;

  for (let i = 0; i < steps; i += 1) {
    const r = margin + scale * ((i + 0.5) / steps);
    for (let j = 0; j < steps; j += 1) {
      const g = margin + scale * ((j + 0.5) / steps);
      for (let k = 0; k < steps; k += 1) {
        const b = margin + scale * ((k + 0.5) / steps);
        triples.push([r, g, b]);
      }
    }
  }

  for (let i = triples.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1)); // important for geometry.setDrawRange to remove random points from cloud
    const temp = triples[i];
    triples[i] = triples[j];
    triples[j] = temp;
  }

  const positions = new Float32Array(total * 3);
  const colors = new Float32Array(total * 3);
  let ptr = 0;
  for (const [r, g, b] of triples) {
    positions[ptr] = r;
    colors[ptr] = r;
    ptr += 1;

    positions[ptr] = g;
    colors[ptr] = g;
    ptr += 1;

    positions[ptr] = b;
    colors[ptr] = b;
    ptr += 1;
  }

  const geometry = new THREE.BufferGeometry();
  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
  geometry.computeBoundingSphere();
  return geometry;
}

function createPointCloudMaterial(
  spectrumTextures,
  initialPointSize,
  placementMode,
  chromaUniform,
  chromaHoverUniform
) {
  const placementCall = placementMode === 'chromaticity' ? 'positionChromaticity' : 'positionInDisplaySpace';

  const vertexShader = /* glsl */ `
    precision highp float;
    #define M_PI 3.1415926535897932384626433832795
    #define WHITEPOINT_SCALE 0.916

    uniform float uTime;
    uniform sampler2D uSpectrumLookupX;
    uniform sampler2D uSpectrumLookupY;
    uniform sampler2D uSpectrumLookupZ;
    uniform float uSpectrumWidth;
    uniform float uPointSize;
    uniform vec2 uChromaticityMatch;
    uniform vec2 uChromaticityMatchHover;

    varying vec3 vXYZColor;

    ${GLSL_CLOUD_UTILS}

    void main() {
      vec3 distribution = cylindricalCloudDistribute(position, uTime);
      vec3 xyz = pushIntoDisplayableXYZCloud(
        uSpectrumLookupX,
        uSpectrumLookupY,
        uSpectrumLookupZ,
        distribution,
        uSpectrumWidth
      );
      vXYZColor = xyz;

      vec3 placed = ${placementCall}(xyz, 1.0);
      if (any(isnan(placed))) {
        placed = vec3(0.0);
      }
      float chromaSum = max(xyz.x + xyz.y + xyz.z, 1e-5);
      vec2 chromaticity = xyz.xy / chromaSum;
      float proximityClicked = 10. * pow(
        1.0 - smoothstep(0.0, 0.05, distance(chromaticity, uChromaticityMatch)),
        2.0
      );
      float proximityHover = 10. * pow(
        1.0 - smoothstep(0.0, 0.05, distance(chromaticity, uChromaticityMatchHover)),
        2.0
      );
      float proximity = max(proximityClicked, proximityHover);
      gl_PointSize = uPointSize + proximity;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(placed, 1.0);
    }
  `;

  const fragmentShader = /* glsl */ `
    precision highp float;

    #define WHITEPOINT_SCALE 0.916
    #define COMPLEMENT_ALPHA 0.3392828462996986

    uniform bool uShowCube;
    uniform bool uP3Enabled;
    uniform bool uSRGBEnabled;
    varying vec3 vXYZColor;

    const vec3 COMPLEMENT_GRAY = vec3(0.4587381755096547);

    const mat3 XYZ_TO_P3 = transpose(mat3(
      2.493496912, -0.931383618, -0.402710784,
     -0.829488970,  1.762664060,  0.023624686,
      0.035845830, -0.076172389,  0.956884524
    ));

    const mat3 XYZ_TO_SRGB = transpose(mat3(
      3.2409699419045226, -1.537383177570094, -0.4986107602930034,
     -0.9692436362808793,  1.8759675015077204,  0.0415550574071756,
      0.0556300796969936, -0.2039769588889765,  1.0569715142428786
    ));

    float linearToDisplayGammaComponent(float channel) {
      return channel <= 0.0031308 ? 12.92 * channel : 1.055 * pow(channel, 1.0 / 2.4) - 0.055;
    }

    vec3 applyDisplayGamma(vec3 linear) {
      return vec3(
        linearToDisplayGammaComponent(linear.r),
        linearToDisplayGammaComponent(linear.g),
        linearToDisplayGammaComponent(linear.b)
      );
    }

    bool isWithinUnitCube(vec3 value) {
      return all(greaterThanEqual(value, vec3(0.0))) && all(lessThanEqual(value, vec3(1.0)));
    }

    void main() {
      vec3 p3_color = XYZ_TO_P3 * vXYZColor;
      vec3 linearResult = mix(COMPLEMENT_GRAY, p3_color, COMPLEMENT_ALPHA);

      if (uShowCube) {
        if (uP3Enabled) {
          vec3 real_p3 = p3_color / WHITEPOINT_SCALE;
          if (isWithinUnitCube(real_p3)) {
            linearResult = real_p3;
          }
        } else if (uSRGBEnabled) {
          vec3 real_srgb = (XYZ_TO_SRGB * vXYZColor) / WHITEPOINT_SCALE;
          if (isWithinUnitCube(real_srgb)) {
            linearResult = real_srgb;
          }
        }
      }

      gl_FragColor = vec4(applyDisplayGamma(linearResult), 1.0);
    }
  `;

const material = new THREE.ShaderMaterial({
    uniforms: {
      uTime: { value: 0 },
      uSpectrumLookupX: { value: spectrumTextures.x },
      uSpectrumLookupY: { value: spectrumTextures.y },
      uSpectrumLookupZ: { value: spectrumTextures.z },
      uSpectrumWidth: { value: spectrumTextures.width },
      uShowCube: { value: true },
      uP3Enabled: { value: true },
      uSRGBEnabled: { value: true },
      uPointSize: { value: initialPointSize },
      uChromaticityMatch: { value: chromaUniform },
      uChromaticityMatchHover: { value: chromaHoverUniform },
    },
    transparent: true,
    depthTest: true,
    blending: THREE.NormalBlending,
    vertexShader,
    fragmentShader,
  });

  material.toneMapped = false;
  return material;
}

function createP3PointCloudMaterial(initialPointSize, placementMode, chromaUniform, chromaHoverUniform) {
  const placementSnippet =
    placementMode === 'chromaticity'
      ? 'vec3 placed = positionChromaticity(distribution, 1.0);'
      : 'vec3 placed = positionInDisplaySpace(WHITEPOINT_SCALE * distribution, 1.0);';

  const vertexShader = /* glsl */ `
    precision highp float;
    #define M_PI 3.1415926535897932384626433832795
    #define WHITEPOINT_SCALE 0.916

    uniform float uTime;
    uniform float uPointSize;
    uniform vec2 uChromaticityMatch;
    uniform vec2 uChromaticityMatchHover;
    varying vec3 vXYZColor;

    ${GLSL_CLOUD_UTILS}

    const mat3 P3_TO_XYZ = transpose(mat3(
      0.4865709487307447, 0.2656676932425557, 0.19821728499580404,
      0.2289745642699899, 0.6917385220595262, 0.07928691395103558,
      0.0000000000726714, 0.04511338174818106, 1.0439443689352284
    ));

    void main() {
      vec3 distribution = P3_TO_XYZ * cubicCloudDistribute(position, uTime);
      vXYZColor = distribution;

      ${placementSnippet}
      if (any(isnan(placed))) {
        placed = vec3(0.0);
      }
      float chromaSum = max(distribution.x + distribution.y + distribution.z, 1e-5);
      vec2 chromaticity = distribution.xy / chromaSum;
      float proximityClicked = 10. * pow(
        1.0 - smoothstep(0.0, 0.05, distance(chromaticity, uChromaticityMatch)),
        2.0
      );
      float proximityHover = 10. * pow(
        1.0 - smoothstep(0.0, 0.05, distance(chromaticity, uChromaticityMatchHover)),
        2.0
      );
      float proximity = max(proximityClicked, proximityHover);
      gl_PointSize = uPointSize + proximity;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(placed, 1.0);
    }
  `;

  const fragmentShader = /* glsl */ `
    precision highp float;

    varying vec3 vXYZColor;

    const mat3 XYZ_TO_P3 = transpose(mat3(
      2.493496912, -0.931383618, -0.402710784,
     -0.829488970,  1.762664060,  0.023624686,
      0.035845830, -0.076172389,  0.956884524
    ));

    float linearToDisplayGammaComponent(float channel) {
      return channel <= 0.0031308 ? 12.92 * channel : 1.055 * pow(channel, 1.0 / 2.4) - 0.055;
    }

    vec3 applyDisplayGamma(vec3 linear) {
      return vec3(
        linearToDisplayGammaComponent(linear.r),
        linearToDisplayGammaComponent(linear.g),
        linearToDisplayGammaComponent(linear.b)
      );
    }

    void main() {
      vec3 p3_color = XYZ_TO_P3 * vXYZColor;
      gl_FragColor = vec4(applyDisplayGamma(p3_color), 1.0);
    }
  `;

  const material = new THREE.ShaderMaterial({
    uniforms: {
      uTime: { value: 0 },
      uPointSize: { value: initialPointSize },
      uChromaticityMatch: { value: chromaUniform },
      uChromaticityMatchHover: { value: chromaHoverUniform },
    },
    transparent: true,
    depthTest: true,
    blending: THREE.NormalBlending,
    vertexShader,
    fragmentShader,
  });

  material.toneMapped = false;
  return material;
}

function createSRGBPointCloudMaterial(initialPointSize, placementMode, chromaUniform, chromaHoverUniform) {
  const placementSnippet =
    placementMode === 'chromaticity'
      ? 'vec3 placed = positionChromaticity(distribution, 1.0);'
      : 'vec3 placed = positionInDisplaySpace(WHITEPOINT_SCALE * distribution, 1.0);';

  const vertexShader = /* glsl */ `
    precision highp float;
    #define M_PI 3.1415926535897932384626433832795
    #define WHITEPOINT_SCALE 0.916

    uniform float uTime;
    uniform float uPointSize;
    uniform vec2 uChromaticityMatch;
    uniform vec2 uChromaticityMatchHover;
    varying vec3 vXYZColor;

    ${GLSL_CLOUD_UTILS}

    const mat3 SRGB_TO_XYZ = transpose(mat3(
      0.4123907992659593, 0.3575843393838776, 0.1804807884018343,
      0.2126390058715102, 0.7151686787677559, 0.0721923153607337,
      0.0193308187155918, 0.1191947797946260, 0.9505321522496607
    ));

    void main() {
      vec3 distribution = SRGB_TO_XYZ * cubicCloudDistribute(position, uTime);
      vXYZColor = distribution;

      ${placementSnippet}
      if (any(isnan(placed))) {
        placed = vec3(0.0);
      }
      float chromaSum = max(distribution.x + distribution.y + distribution.z, 1e-5);
      vec2 chromaticity = distribution.xy / chromaSum;
      float proximityClicked = 10. * pow(
        1.0 - smoothstep(0.0, 0.05, distance(chromaticity, uChromaticityMatch)),
        2.0
      );
      float proximityHover = 10. * pow(
        1.0 - smoothstep(0.0, 0.05, distance(chromaticity, uChromaticityMatchHover)),
        2.0
      );
      float proximity = max(proximityClicked, proximityHover);
      gl_PointSize = uPointSize + proximity;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(placed, 1.0);
    }
  `;

  const fragmentShader = /* glsl */ `
    precision highp float;

    varying vec3 vXYZColor;

    const mat3 XYZ_TO_P3 = transpose(mat3(
      2.493496912, -0.931383618, -0.402710784,
     -0.829488970,  1.762664060,  0.023624686,
      0.035845830, -0.076172389,  0.956884524
    ));

    float linearToDisplayGammaComponent(float channel) {
      return channel <= 0.0031308 ? 12.92 * channel : 1.055 * pow(channel, 1.0 / 2.4) - 0.055;
    }

    vec3 applyDisplayGamma(vec3 linear) {
      return vec3(
        linearToDisplayGammaComponent(linear.r),
        linearToDisplayGammaComponent(linear.g),
        linearToDisplayGammaComponent(linear.b)
      );
    }

    void main() {
      vec3 p3_color = XYZ_TO_P3 * vXYZColor;
      gl_FragColor = vec4(applyDisplayGamma(p3_color), 1.0);
    }
  `;

  const material = new THREE.ShaderMaterial({
    uniforms: {
      uTime: { value: 0 },
      uPointSize: { value: initialPointSize },
      uChromaticityMatch: { value: chromaUniform },
      uChromaticityMatchHover: { value: chromaHoverUniform },
    },
    transparent: true,
    depthTest: true,
    blending: THREE.NormalBlending,
    vertexShader,
    fragmentShader,
  });

  material.toneMapped = false;
  return material;
}

function createComplementSpectrumTextures() {
  const width = lookupTable.length / 3;

  const dataX = new Float32Array(width * 4);
  const dataY = new Float32Array(width * 4);
  const dataZ = new Float32Array(width * 4);

  for (let i = 0; i < width; i += 1) {
    const r = lookupTable[3 * i];
    const g = lookupTable[3 * i + 1];
    const b = lookupTable[3 * i + 2];

    const idx = 4 * i;
    dataX[idx] = r;
    dataX[idx + 1] = 0;
    dataX[idx + 2] = 0;
    dataX[idx + 3] = 1;

    dataY[idx] = g;
    dataY[idx + 1] = 0;
    dataY[idx + 2] = 0;
    dataY[idx + 3] = 1;

    dataZ[idx] = b;
    dataZ[idx + 1] = 0;
    dataZ[idx + 2] = 0;
    dataZ[idx + 3] = 1;
  }

  const textureX = new THREE.DataTexture(dataX, width, 1, THREE.RGBAFormat, THREE.FloatType);
  textureX.magFilter = THREE.LinearFilter;
  textureX.minFilter = THREE.LinearFilter;
  textureX.wrapS = THREE.ClampToEdgeWrapping;
  textureX.wrapT = THREE.ClampToEdgeWrapping;
  textureX.generateMipmaps = false;
  textureX.needsUpdate = true;

  const textureY = new THREE.DataTexture(dataY, width, 1, THREE.RGBAFormat, THREE.FloatType);
  textureY.magFilter = THREE.LinearFilter;
  textureY.minFilter = THREE.LinearFilter;
  textureY.wrapS = THREE.ClampToEdgeWrapping;
  textureY.wrapT = THREE.ClampToEdgeWrapping;
  textureY.generateMipmaps = false;
  textureY.needsUpdate = true;

  const textureZ = new THREE.DataTexture(dataZ, width, 1, THREE.RGBAFormat, THREE.FloatType);
  textureZ.magFilter = THREE.LinearFilter;
  textureZ.minFilter = THREE.LinearFilter;
  textureZ.wrapS = THREE.ClampToEdgeWrapping;
  textureZ.wrapT = THREE.ClampToEdgeWrapping;
  textureZ.generateMipmaps = false;
  textureZ.needsUpdate = true;

  return {
    x: textureX,
    y: textureY,
    z: textureZ,
    width,
  };
}
