<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BBWS173BMQ"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-BBWS173BMQ');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Color Cloud</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.166.0/build/three.module.js"
      }
    }
  </script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
  <main class="column">
    <section class="dashboard">
      <div class="dashboard-left">
        <header class="intro">
          <h1>Chromaticity Clouds</h1>
          <p>Exploring gamuts of the tristimulus color spaces of sRGB and P3. Included is the standard chromaticity diagram and an interactive 3D diagram showing the sRGB and P3 cubes in XYZ space, along with a larger gamut (desaturated for displayability) representing the range of all possible tristimulus color spaces. Read more <a href="https://agaura.github.io/chromaticity-clouds/index.html" target="_blank" rel="noopener">here</a>.</p>
        </header>
        <section class="controls" aria-label="Shader controls">
          <div class="slider-row">
            <label for="pointSizeSlider">Point Size</label>
            <input type="range" id="pointSizeSlider" min="1" max="10" step="0.1" value="1" />
            <span id="pointSizeValue">1.0</span>
          </div>
          <div class="cloud-toggles" role="group" aria-label="Cloud visibility">
            <label><input type="checkbox" id="toggleMaxGamut" checked /> (Max)</label>
            <label><input type="checkbox" id="toggleSRGB" checked /> sRGB</label>
            <label><input type="checkbox" id="toggleP3" checked /> P3</label>
            <label><input type="checkbox" id="toggleRec2020" /> Rec. 2020</label>
          </div>
        </section>
        <div id="chartContainer" class="chart-container">
          <svg id="chartSvg" aria-hidden="true"></svg>
          <canvas id="chromaticityCanvas" aria-label="Chromaticity point cloud"></canvas>
          <div id="chromaticityActiveLabel" class="chromaticity-label chromaticity-label--active" aria-hidden="true"></div>
          <div id="chromaticityHoverLabel" class="chromaticity-label chromaticity-label--hover" aria-hidden="true"></div>
        </div>
      </div>
      <div class="panel panel-space">
        <canvas id="spaceCanvas" aria-label="Gamut point cloud"></canvas>
        <div class="spectrum-strip" aria-label="Visible light spectrum reference">
          <canvas id="spectrumStripCanvas" aria-label="Visible light spectrum"></canvas>
          <div id="spectrumStripAxis" class="spectrum-strip-axis"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('chartContainer');
      const svg = d3.select('#chartSvg');
      const canvas = document.getElementById('chromaticityCanvas');
      const margin = { top: 36, right: 36, bottom: 52, left: 52 };

      const plotGroup = svg.append('g').attr('class', 'plot-area');
      const gridGroup = plotGroup.append('g').attr('class', 'grid-lines');
      const xAxisGroup = svg.append('g').attr('class', 'axis axis-x');
      const yAxisGroup = svg.append('g').attr('class', 'axis axis-y');
      const xLabel = svg.append('text').attr('class', 'axis-label axis-label-x').text('x');
      const yLabel = svg.append('text').attr('class', 'axis-label axis-label-y').text('y');

      const renderChart = () => {
        const size = container.clientWidth;
        const width = Math.max(1, size - margin.left - margin.right);
        const height = Math.max(1, size - margin.top - margin.bottom);

        svg.attr('width', size).attr('height', size);
        plotGroup.attr('transform', `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear().domain([0, 0.9]).range([0, width]);
        const y = d3.scaleLinear().domain([0, 0.9]).range([height, 0]);

        const xTicks = x.ticks(9);
        const yTicks = y.ticks(9);

        const verticalLines = gridGroup.selectAll('line.grid-vertical').data(xTicks);
        verticalLines.join(
          enter => enter.append('line').attr('class', 'grid grid-vertical')
        )
          .attr('x1', d => x(d))
          .attr('x2', d => x(d))
          .attr('y1', 0)
          .attr('y2', height);

        const horizontalLines = gridGroup.selectAll('line.grid-horizontal').data(yTicks);
        horizontalLines.join(
          enter => enter.append('line').attr('class', 'grid grid-horizontal')
        )
          .attr('x1', 0)
          .attr('x2', width)
          .attr('y1', d => y(d))
          .attr('y2', d => y(d));

        xAxisGroup
          .attr('transform', `translate(${margin.left}, ${margin.top + height})`)
          .call(d3.axisBottom(x).tickSizeOuter(0).tickFormat(d3.format('.1f')));

        yAxisGroup
          .attr('transform', `translate(${margin.left}, ${margin.top})`)
          .call(d3.axisLeft(y).tickSizeOuter(0).tickFormat(d3.format('.1f')));

        xLabel
          .attr('x', margin.left + width / 2)
          .attr('y', margin.top + height + 40);

        yLabel
          .attr('x', margin.left - 36)
          .attr('y', margin.top + height / 2)
          .attr('transform', `rotate(-90, ${margin.left - 36}, ${margin.top + height / 2})`);

        Object.assign(canvas.style, {
          width: `${width}px`,
          height: `${height}px`,
          left: `${margin.left}px`,
          top: `${margin.top}px`,
        });

        const prevWidth = Number(canvas.dataset.prevWidth || 0);
        const prevHeight = Number(canvas.dataset.prevHeight || 0);
        if (prevWidth !== width || prevHeight !== height) {
          canvas.dataset.prevWidth = width;
          canvas.dataset.prevHeight = height;
          window.dispatchEvent(new Event('resize'));
        }
      };

      renderChart();
      window.addEventListener('resize', renderChart);
    });
  </script>
  <script type="module" src="point-cloud.js"></script>
</body>
</html>
